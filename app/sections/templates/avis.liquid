{% comment %}
  Section: Avis Clients avec système de notation
{% endcomment %}

<style>
  .reviews-section-{{ section.id }} {
    background-color: {{ section.settings.background_color }};
    padding: {{ section.settings.padding_mobile }}px ;
  }

  @media (min-width: 768px) {
    .reviews-section-{{ section.id }} {
      padding: {{ section.settings.padding_desktop }}px 40px;
    }
  }

  .reviews-container-{{ section.id }} {
    max-width: 1400px;
    margin: 0 auto;
  }

    .reviews-header-{{ section.id }} {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid #333333;
    }


    .reviews-rating-summary-{{ section.id }} {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    }

  .reviews-rating-number-{{ section.id }} {
    font-size: {{ section.settings.rating_size_mobile }}px;
    font-weight: bold;
    color: {{ section.settings.text_color }};
  }

  @media (min-width: 768px) {
    .reviews-rating-number-{{ section.id }} {
      font-size: {{ section.settings.rating_size_desktop }}px;
    }
  }

  .reviews-stars-{{ section.id }} {
    display: flex;
    gap: 2px;
  }

  .reviews-star-{{ section.id }} {
    color: #ffa500;
    font-size: {{ section.settings.star_size_mobile }}px;
  }

  @media (min-width: 768px) {
    .reviews-star-{{ section.id }} {
      font-size: {{ section.settings.star_size_desktop }}px;
    }
  }

  .reviews-count-{{ section.id }} {
    font-size: {{ section.settings.count_size_mobile }}px;
    color: {{ section.settings.text_color }};
  }

  @media (min-width: 768px) {
    .reviews-count-{{ section.id }} {
      font-size: {{ section.settings.count_size_desktop }}px;
    }
  }

.reviews-actions-{{ section.id }} {
  display: flex;
  gap: 15px;
  align-items: center;
  flex-wrap: wrap;
}

  .reviews-write-btn-{{ section.id }} {
    background-color: {{ section.settings.button_bg_color }};
    color: {{ section.settings.button_text_color }};
    border: 1px solid {{ section.settings.button_border_color }};
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-size: {{ section.settings.button_size_mobile }}px;
    transition: all 0.3s;
    white-space: nowrap;
  }

  @media (min-width: 768px) {
    .reviews-write-btn-{{ section.id }} {
      font-size: {{ section.settings.button_size_desktop }}px;
    }
  }

  .reviews-write-btn-{{ section.id }}:hover {
    opacity: 0.8;
  }


    .reviews-sort-container-{{ section.id }} {
    position: relative;
    display: inline-block;
    }

    .reviews-sort-icon-{{ section.id }} {
    width: 24px;
    height: 24px;
    cursor: pointer;
    color: {{ section.settings.text_color }};
    }


    .reviews-sort-select-{{ section.id }} {
    position: absolute;
    top: 35px;
    right: 0;
    padding: 8px 12px;
    border: 1px solid {{ section.settings.button_border_color }};
    border-radius: 4px;
    background-color: {{ section.settings.card_bg_color }};
    color: {{ section.settings.text_color }};
    font-size: {{ section.settings.select_size_mobile }}px;
    cursor: pointer;
    display: none;
    min-width: 200px;
    z-index: 10;
    }

    .reviews-sort-select-{{ section.id }}.active {
    display: block;
    }


    @media (min-width: 768px) {
    .reviews-sort-select-{{ section.id }} {
        font-size: {{ section.settings.select_size_desktop }}px;
    }
    }

    .reviews-grid-{{ section.id }} {
    column-count: 2;
    column-gap: 15px;
    margin-top: 30px;
    }

    @media (min-width: 768px) {
    .reviews-grid-{{ section.id }} {
        column-count: 3;
        column-gap: 20px;
    }
    }

    @media (min-width: 1024px) {
    .reviews-grid-{{ section.id }} {
        column-count: 4;
    }
    }

    @media (min-width: 1400px) {
    .reviews-grid-{{ section.id }} {
        column-count: 5;
    }
    }

    .review-card-{{ section.id }} {
    background-color: {{ section.settings.card_bg_color }};
    border-radius: 8px;
    overflow: hidden;
    display: inline-block;
    width: 100%;
    margin-bottom: 15px;
    break-inside: avoid;
    vertical-align: top;
    }

    @media (min-width: 768px) {
    .review-card-{{ section.id }} {
        margin-bottom: 20px;
    }
    }


  .review-image-container-{{ section.id }} {
    width: 100%;
    position: relative;
    overflow: hidden;
  }

  .review-image-{{ section.id }} {
    width: 100%;
    height: auto;
    display: block;
  }

  .review-content-{{ section.id }} {
    padding: 20px;
    display: block;
  }

  .review-stars-container-{{ section.id }} {
    display: flex;
    gap: 2px;
    margin-bottom: 10px;
  }

  .review-star-{{ section.id }} {
    color: #ffa500;
    font-size: {{ section.settings.card_star_size_mobile }}px;
  }

  @media (min-width: 768px) {
    .review-star-{{ section.id }} {
      font-size: {{ section.settings.card_star_size_desktop }}px;
    }
  }

  .review-name-{{ section.id }} {
    font-weight: bold;
    color: {{ section.settings.text_color }};
    font-size: {{ section.settings.name_size_mobile }}px;
    margin-bottom: 10px;
  }

  @media (min-width: 768px) {
    .review-name-{{ section.id }} {
      font-size: {{ section.settings.name_size_desktop }}px;
    }
  }

  .review-text-{{ section.id }} {
    color: {{ section.settings.text_color }};
    line-height: 1.6;
    font-size: {{ section.settings.review_text_size_mobile }}px;
    margin-bottom: 10px;
  }

  @media (min-width: 768px) {
    .review-text-{{ section.id }} {
      font-size: {{ section.settings.review_text_size_desktop }}px;
    }
  }

  .review-text-truncated {
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .review-text-expanded {
    display: block;
  }


  .review-read-more-{{ section.id }} {
    color: {{ section.settings.link_color }};
    cursor: pointer;
    text-decoration: underline;
    font-size: {{ section.settings.link_size_mobile }}px;
    background: none;
    border: none;
    padding: 0;
    text-align: left;
  }

  @media (min-width: 768px) {
    .review-read-more-{{ section.id }} {
      font-size: {{ section.settings.link_size_desktop }}px;
    }
  }

  .review-read-more-{{ section.id }}:hover {
    opacity: 0.7;
  }

  
</style>

<div class="reviews-section-{{ section.id }}">
  <div class="reviews-container-{{ section.id }}">
    <div class="reviews-header-{{ section.id }}">
    <div class="reviews-rating-summary-{{ section.id }}">
        <span class="reviews-rating-number-{{ section.id }}">{{ section.settings.average_rating }}</span>
        <div class="reviews-stars-{{ section.id }}">
        {% for i in (1..5) %}
            <span class="reviews-star-{{ section.id }}">★</span>
        {% endfor %}
        </div>
        <span class="reviews-count-{{ section.id }}">{{ section.blocks.size }} avis</span>
    </div>

    <div class="reviews-actions-{{ section.id }}">
        <button class="reviews-write-btn-{{ section.id }}" >
        Écrire un commentaire
        </button>

        <div class="reviews-sort-container-{{ section.id }}">
        <svg class="reviews-sort-icon-{{ section.id }}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" onclick="toggleSortMenu{{ section.id }}()">
            <line x1="4" y1="6" x2="20" y2="6"></line>
            <line x1="4" y1="12" x2="20" y2="12"></line>
            <line x1="4" y1="18" x2="20" y2="18"></line>
        </svg>

        <select class="reviews-sort-select-{{ section.id }}" id="sortSelect{{ section.id }}" onchange="sortReviews{{ section.id }}(this.value)">
            <option value="recent">Le plus récent</option>
            <option value="highest">Notes les plus élevées</option>
            <option value="lowest">Notes les plus basses</option>
        </select>
        </div>
    </div>
    </div>

    <div class="reviews-grid-{{ section.id }}" id="reviewsGrid{{ section.id }}">
      {% for block in section.blocks %}
        <div class="review-card-{{ section.id }}" data-rating="{{ block.settings.rating }}" data-index="{{ forloop.index }}">
          {% if block.settings.image != blank %}
            <div class="review-image-container-{{ section.id }}">
              <img src="{{ block.settings.image | image_url: width: 800 }}" alt="Review image" class="review-image-{{ section.id }}">
            </div>
          {% endif %}
          
          <div class="review-content-{{ section.id }}">
            <div class="review-stars-container-{{ section.id }}">
              {% for i in (1..5) %}
                {% if i <= block.settings.rating %}
                  <span class="review-star-{{ section.id }}">★</span>
                {% else %}
                  <span class="review-star-{{ section.id }}" style="color: #ccc;">★</span>
                {% endif %}
              {% endfor %}
            </div>
            
            <div class="review-name-{{ section.id }}">{{ block.settings.name }}</div>
            
            <div class="review-text-wrapper-{{ section.id }}-{{ forloop.index }}">
                <div class="review-text-{{ section.id }} review-text-truncated" id="reviewText{{ section.id }}-{{ forloop.index }}">
                    {{ block.settings.review_text }}
                </div>
                <button class="review-read-more-{{ section.id }}"
                        type="button"
                        data-review-target="reviewText{{ section.id }}-{{ forloop.index }}"
                        hidden>
                  Voir l'avis complet
                </button>
              {% if block.settings.review_text.size > 200 %}
                
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
  (function() {
    const sectionId = {{ section.id | json }};
    const sectionRoot = document.querySelector(`.reviews-section-${sectionId}`);
    if (!sectionRoot) {
      return;
    }

    const sortSelect = sectionRoot.querySelector(`#sortSelect${sectionId}`);
    const sortContainer = sectionRoot.querySelector(`.reviews-sort-container-${sectionId}`);
    const sortIcon = sectionRoot.querySelector(`.reviews-sort-icon-${sectionId}`);
    const reviewsGrid = sectionRoot.querySelector(`#reviewsGrid${sectionId}`);
    const readMoreButtons = sectionRoot.querySelectorAll(`.review-read-more-${sectionId}`);

    const toggleSortMenu = () => {
      if (sortSelect) {
        sortSelect.classList.toggle('active');
      }
    };

    const sortReviews = (sortType) => {
      if (!reviewsGrid) {
        return;
      }
      const cards = Array.from(reviewsGrid.querySelectorAll(`.review-card-${sectionId}`));
      cards.forEach((card) => card.remove());

      cards.sort((a, b) => {
        const ratingA = parseInt(a.dataset.rating, 10);
        const ratingB = parseInt(b.dataset.rating, 10);
        const indexA = parseInt(a.dataset.index, 10);
        const indexB = parseInt(b.dataset.index, 10);

        if (sortType === 'highest') {
          return ratingB - ratingA || indexA - indexB;
        }
        if (sortType === 'lowest') {
          return ratingA - ratingB || indexA - indexB;
        }
        return indexB - indexA;
      });

      cards.forEach((card) => reviewsGrid.appendChild(card));
      sortSelect?.classList.remove('active');
    };

    if (sortIcon) {
      sortIcon.addEventListener('click', (event) => {
        event.stopPropagation();
        toggleSortMenu();
      });
    }

    if (sortSelect) {
      sortSelect.addEventListener('change', (event) => {
        sortReviews(event.target.value);
      });
    }

    if (sortContainer && sortSelect) {
      document.addEventListener('click', (event) => {
        if (sortSelect.classList.contains('active') && !sortContainer.contains(event.target)) {
          sortSelect.classList.remove('active');
        }
      });
    }

    readMoreButtons.forEach((button) => {
      const targetId = button.dataset.reviewTarget;
      if (!targetId) {
        button.hidden = true;
        return;
      }

      const textElement = document.getElementById(targetId);
      if (!textElement) {
        button.hidden = true;
        return;
      }

      const updateButtonVisibility = () => {
        if (!textElement.classList.contains('review-text-truncated')) {
          button.hidden = false;
          return;
        }
        const isOverflowing = textElement.scrollHeight - textElement.clientHeight > 1;
        button.hidden = !isOverflowing;
      };

      const scheduleVisibilityCheck = () => {
        if (typeof requestAnimationFrame === 'function') {
          requestAnimationFrame(updateButtonVisibility);
        } else {
          updateButtonVisibility();
        }
      };

      scheduleVisibilityCheck();

      if (typeof ResizeObserver !== 'undefined') {
        const observer = new ResizeObserver(updateButtonVisibility);
        observer.observe(textElement);
      } else {
        window.addEventListener('resize', updateButtonVisibility);
      }

      button.addEventListener('click', () => {
        if (textElement.classList.contains('review-text-truncated')) {
          textElement.classList.remove('review-text-truncated');
          textElement.classList.add('review-text-expanded');
          button.textContent = 'Réduire';
        } else {
          textElement.classList.remove('review-text-expanded');
          textElement.classList.add('review-text-truncated');
          button.textContent = "Voir l'avis complet";
        }
        updateButtonVisibility();
      });
    });
  })();
</script>

{% schema %}
{
  "name": "Avis Clients",
  "settings": [
    {
      "type": "header",
      "content": "Couleurs"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Couleur de fond",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Couleur du texte",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "card_bg_color",
      "label": "Couleur de fond des cartes",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "button_bg_color",
      "label": "Couleur de fond du bouton",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Couleur du texte du bouton",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "button_border_color",
      "label": "Couleur de bordure",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "link_color",
      "label": "Couleur des liens",
      "default": "#888888"
    },
    {
      "type": "header",
      "content": "Note moyenne"
    },
    {
      "type": "text",
      "id": "average_rating",
      "label": "Note moyenne",
      "default": "5.0"
    },
    {
      "type": "header",
      "content": "Tailles Desktop"
    },
    {
      "type": "range",
      "id": "card_width_desktop",
      "label": "Largeur des cartes Desktop (px)",
      "min": 200,
      "max": 500,
      "step": 20,
      "default": 300
    },
    {
      "type": "range",
      "id": "padding_desktop",
      "label": "Padding Desktop",
      "min": 0,
      "max": 120,
      "step": 10,
      "default": 60
    },
    {
      "type": "range",
      "id": "rating_size_desktop",
      "label": "Taille note Desktop",
      "min": 0,
      "max": 60,
      "step": 2,
      "default": 32
    },
    {
      "type": "range",
      "id": "star_size_desktop",
      "label": "Taille étoiles Desktop",
      "min": 16,
      "max": 40,
      "step": 2,
      "default": 24
    },
    {
      "type": "range",
      "id": "count_size_desktop",
      "label": "Taille compteur Desktop",
      "min": 12,
      "max": 30,
      "step": 2,
      "default": 16
    },
    {
      "type": "range",
      "id": "button_size_desktop",
      "label": "Taille bouton Desktop",
      "min": 12,
      "max": 24,
      "step": 1,
      "default": 14
    },
    {
      "type": "range",
      "id": "select_size_desktop",
      "label": "Taille sélecteur Desktop",
      "min": 12,
      "max": 24,
      "step": 1,
      "default": 14
    },
    {
      "type": "range",
      "id": "card_star_size_desktop",
      "label": "Taille étoiles carte Desktop",
      "min": 12,
      "max": 30,
      "step": 2,
      "default": 18
    },
    {
      "type": "range",
      "id": "name_size_desktop",
      "label": "Taille nom Desktop",
      "min": 14,
      "max": 30,
      "step": 2,
      "default": 16
    },
    {
      "type": "range",
      "id": "review_text_size_desktop",
      "label": "Taille texte avis Desktop",
      "min": 12,
      "max": 24,
      "step": 1,
      "default": 14
    },
    {
      "type": "range",
      "id": "link_size_desktop",
      "label": "Taille lien Desktop",
      "min": 12,
      "max": 20,
      "step": 1,
      "default": 13
    },
    {
      "type": "header",
      "content": "Tailles Mobile"
    },
    {
      "type": "range",
      "id": "card_width_mobile",
      "label": "Largeur minimale des cartes Mobile (px)",
      "min": 50,
      "max": 400,
      "step": 10,
      "default": 180
    },
    {
      "type": "range",
      "id": "padding_mobile",
      "label": "Padding Mobile",
      "min": 0,
      "max": 80,
      "step": 10,
      "default": 40
    },
    {
      "type": "range",
      "id": "rating_size_mobile",
      "label": "Taille note Mobile",
      "min": 16,
      "max": 40,
      "step": 2,
      "default": 24
    },
    {
      "type": "range",
      "id": "star_size_mobile",
      "label": "Taille étoiles Mobile",
      "min": 14,
      "max": 30,
      "step": 2,
      "default": 18
    },
    {
      "type": "range",
      "id": "count_size_mobile",
      "label": "Taille compteur Mobile",
      "min": 12,
      "max": 24,
      "step": 1,
      "default": 14
    },
    {
      "type": "range",
      "id": "button_size_mobile",
      "label": "Taille bouton Mobile",
      "min": 12,
      "max": 20,
      "step": 1,
      "default": 13
    },
    {
      "type": "range",
      "id": "select_size_mobile",
      "label": "Taille sélecteur Mobile",
      "min": 12,
      "max": 20,
      "step": 1,
      "default": 13
    },
    {
      "type": "range",
      "id": "card_star_size_mobile",
      "label": "Taille étoiles carte Mobile",
      "min": 12,
      "max": 24,
      "step": 2,
      "default": 16
    },

    {
      "type": "range",
      "id": "name_size_mobile",
      "label": "Taille nom Mobile",
      "min": 14,
      "max": 24,
      "step": 1,
      "default": 15
    },
    {
      "type": "range",
      "id": "review_text_size_mobile",
      "label": "Taille texte avis Mobile",
      "min": 12,
      "max": 20,
      "step": 1,
      "default": 13
    },
    {
      "type": "range",
      "id": "link_size_mobile",
      "label": "Taille lien Mobile",
      "min": 11,
      "max": 18,
      "step": 1,
      "default": 12
    }
  ],
  "blocks": [
    {
      "type": "review",
      "name": "Avis",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image de l'avis"
        },
        {
          "type": "range",
          "id": "rating",
          "label": "Note (étoiles)",
          "min": 1,
          "max": 5,
          "step": 1,
          "default": 5
        },
        {
          "type": "text",
          "id": "name",
          "label": "Nom du client",
          "default": "Client"
        },
        {
          "type": "textarea",
          "id": "review_text",
          "label": "Texte de l'avis",
          "default": "Excellent produit, je recommande vivement!"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Avis Clients",
      "blocks": [
        {
          "type": "review"
        },
        {
          "type": "review"
        }
      ]
    }
  ]
}
{% endschema %}