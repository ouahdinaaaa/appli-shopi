<section id="shop-market-{{ section.id }}"
  class="market-section"
  style="
    --section-bg: {{ section.settings.section_bg_color }};
    --text-color: {{ section.settings.text_color }};
    --title-color: {{ section.settings.heading_color }};
    --line-color: {{ section.settings.heading_line_color }};
    --accent-color: {{ section.settings.accent_color }};
    --icon-color: {{ section.settings.icon_color }};
    --price-now-color: {{ section.settings.price_now_color }};
    --price-before-color: {{ section.settings.price_before_color }};
    --card-radius: {{ section.settings.card_radius }}px;
    --grid-gap: {{ section.settings.grid_gap }}px;
    --min-card-width: {{ section.settings.min_card_width }}px;
    --max-width: {{ section.settings.max_width }};
    --pad-x: {{ section.settings.section_padding_x }}px;
    --pad-y: {{ section.settings.section_padding_y }}px;
    --default-card-bg: {{ section.settings.card_default_bg }};
    --default-name-bg: {{ section.settings.name_panel_bg }};
    --default-name-color: {{ section.settings.name_panel_text_color }};
  ">

  {% if section.settings.show_heading %}
    <h1 class="title-shop" style="--title-size-desktop: {{ section.settings.heading_size_desktop }}rem; --title-size-mobile: {{ section.settings.heading_size_mobile }}rem;">
      {{ section.settings.heading | escape }}
    </h1>
  {% endif %}

  {%- comment -%} ⭐️ DONNÉES PAR DÉFAUT {%- endcomment -%}
  {% assign default_images = 
    "https://images.pexels.com/photos/15799258/pexels-photo-15799258.jpeg,
     https://images.pexels.com/photos/20429596/pexels-photo-20429596.jpeg,
     https://images.pexels.com/photos/3266703/pexels-photo-3266703.jpeg,
     https://images.pexels.com/photos/7407595/pexels-photo-7407595.png" | split: "," %}

  {% assign default_titles = "Boucles d'oreilles,Braslet,Bagues,Pendentifs" | split: "," %}
  {% assign default_prices = "29.90,19.90,24.90,34.90" | split: "," %}
  {% assign default_compare = "39.90,29.90,34.90,49.90" | split: "," %}

  <div class="main bd-grid">
    {% for block in section.blocks %}
      {% assign product = block.settings.product %}
      {% assign index = forloop.index0 %}

      {% if product != blank %}
        {%- comment -%} PRODUIT RÉEL {%- endcomment -%}
        {% assign current_variant = product.selected_or_first_available_variant %}
        {% assign label_text = block.settings.side_label %}
        {% if block.settings.use_product_title_as_label %}
          {% assign label_text = product.title %}
        {% endif %}

        <article class="card" {{ block.shopify_attributes }}
          style="
            {% if block.settings.card_bg_color != blank %}--card-bg: {{ block.settings.card_bg_color }};{% endif %}
            {% if block.settings.side_bg_color != blank %}--name-bg: {{ block.settings.side_bg_color }};{% endif %}
            {% if block.settings.side_text_color != blank %}--name-color: {{ block.settings.side_text_color }};{% endif %}
          ">
          
          <div class="card__img">
            {% if current_variant.featured_image %}
              <img src="{{ current_variant.featured_image | img_url: '400x' }}" alt="{{ product.title | escape }}" loading="lazy">
            {% elsif product.featured_image %}
              <img src="{{ product.featured_image | img_url: '400x' }}" alt="{{ product.title | escape }}" loading="lazy">
            {% else %}
              <img src="{{ 'product-placeholder.svg' | asset_url }}" alt="{{ product.title | escape }}">
            {% endif %}
          </div>

          <div class="card__name">
            <p>{{ label_text }}</p>
          </div>

          <div class="card__precis">
            {% if block.settings.show_heart %}
              <a href="{{ product.url }}" class="card__icon" aria-label="Voir {{ product.title }}">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                  <path d="M12.1 20.3l-.1.1-.1-.1C7.14 16.36 4 13.52 4 10.5 4 8.5 5.5 7 7.5 7c1.23 0 2.41.57 3.15 1.54.32.41.88.41 1.2 0C12.59 7.57 13.77 7 15 7c2 0 3.5 1.5 3.5 3.5 0 3.02-3.14 5.86-6.4 9.8z" stroke="currentColor" fill="none" stroke-width="1.5"/>
                </svg>
              </a>
            {% endif %}

            <div class="card__prices">
              {% if block.settings.show_compare_price and current_variant.compare_at_price > current_variant.price %}
                <span class="card__preci card__preci--before">{{ current_variant.compare_at_price | money }}</span>
              {% endif %}
              <span class="card__preci card__preci--now">{{ current_variant.price | money }}</span>
            </div>

            {% if block.settings.show_cart %}
              <button class="card__icon" aria-label="Ajouter {{ product.title }} au panier" data-product-id="{{ product.id }}" data-variant-id="{{ current_variant.id }}">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                  <path d="M6 6h15l-1.5 9h-12L6 6z" stroke="currentColor" stroke-width="1.5" fill="none"/>
                  <circle cx="9" cy="20" r="1.5" stroke="currentColor" stroke-width="1.5" fill="none"/>
                  <circle cx="17" cy="20" r="1.5" stroke="currentColor" stroke-width="1.5" fill="none"/>
                </svg>
              </button>
            {% endif %}
          </div>
        </article>

      {% else %}
        {%- comment -%} PLACEHOLDER {%- endcomment -%}
        <article class="card placeholder" {{ block.shopify_attributes }}>
          <div class="card__img">
            <img 
              src="{{ default_images[index] | strip }}"
              alt="{{ default_titles[index] | strip }}"
              loading="lazy"
            >
          </div>

          <div class="card__name">
            <p>{{ default_titles[index] | strip }}</p>
          </div>

          <div class="card__precis">
            {% if block.settings.show_heart %}
              <button class="card__icon" aria-label="Favori">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                  <path d="M12.1 20.3l-.1.1-.1-.1C7.14 16.36 4 13.52 4 10.5 4 8.5 5.5 7 7.5 7c1.23 0 2.41.57 3.15 1.54.32.41.88.41 1.2 0C12.59 7.57 13.77 7 15 7c2 0 3.5 1.5 3.5 3.5 0 3.02-3.14 5.86-6.4 9.8z" stroke="currentColor" fill="none" stroke-width="1.5"/>
                </svg>
              </button>
            {% endif %}

            <div class="card__prices">
              <span class="card__preci card__preci--before">{{ default_compare[index] | append: " €" }}</span>
              <span class="card__preci card__preci--now">{{ default_prices[index] | append: " €" }}</span>
            </div>

            {% if block.settings.show_cart %}
              <button class="card__icon" aria-label="Ajouter au panier">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                  <path d="M6 6h15l-1.5 9h-12L6 6z" stroke="currentColor" stroke-width="1.5" fill="none"/>
                  <circle cx="9" cy="20" r="1.5" stroke="currentColor" stroke-width="1.5" fill="none"/>
                  <circle cx="17" cy="20" r="1.5" stroke="currentColor" stroke-width="1.5" fill="none"/>
                </svg>
              </button>
            {% endif %}
          </div>
        </article>
      {% endif %}
    {% endfor %}
  </div>
</section>

{%- comment -%} Le CSS reste identique {%- endcomment -%}
<style>
  #shop-market-{{ section.id }} {
    background: var(--section-bg);
    color: var(--text-color);
    padding: var(--pad-y) var(--pad-x);
    margin: 0;
    font-family: var(--font-body-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol');
  }

  #shop-market-{{ section.id }} .title-shop {
    position: relative;
    margin: 0 calc(var(--pad-x) + 0px) 1rem;
    font-size: var(--title-size-mobile);
    color: var(--title-color);
    line-height: 1.15;
  }
  #shop-market-{{ section.id }} .title-shop::after {
    {% if section.settings.show_heading_line %}
      content: '';
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 72px;
      height: 2px;
      background-color: var(--line-color);
      margin-left: .25rem;
    {% else %}
      content: none;
    {% endif %}
  }

  @media (min-width: 768px) {
    #shop-market-{{ section.id }} .title-shop { font-size: var(--title-size-desktop); }
  }

  #shop-market-{{ section.id }} .bd-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(var(--min-card-width), 1fr));
    max-width: var(--max-width);
    margin-left: auto;
    margin-right: auto;
    align-items: stretch;
    gap: var(--grid-gap);
  }

  #shop-market-{{ section.id }} .card {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1.5rem 2rem;
    border-radius: var(--card-radius);
    overflow: hidden;
    background: var(--card-bg, var(--default-card-bg));
    transition: box-shadow .3s ease, transform .3s ease;
  }

  {% if section.settings.hover_shadow %}
  #shop-market-{{ section.id }} .card:hover {
    box-shadow: 0 .5rem 1rem rgba(0,0,0,.12);
  }
  {% endif %}

  #shop-market-{{ section.id }} .card__img {
    width: 180px;
    height: auto;
    padding: 3rem 0;
    transition: transform .5s ease, margin-left .5s ease;
    display: block;
  }
  #shop-market-{{ section.id }} .card__img img { width: 100%; height: auto; display:block; }

  #shop-market-{{ section.id }} .card__name {
    position: absolute;
    left: -25%;
    top: 0;
    width: 3.5rem;
    height: 100%;
    writing-mode: vertical-rl;
    transform: rotate(180deg);
    text-align: center;
    background-color: var(--name-bg, var(--default-name-bg));
    color: var(--name-color, var(--default-name-color));
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: left .5s ease;
    text-decoration: none;
  }
  #shop-market-{{ section.id }} .card__name p { margin: 0; padding: .5rem 0; }

  #shop-market-{{ section.id }} .card__precis {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    transition: margin-left .5s ease, padding .5s ease;
  }

  #shop-market-{{ section.id }} .card__icon {
    font-size: 1.5rem;
    color: var(--icon-color);
    background: transparent;
    border: none;
    padding: .25rem;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  #shop-market-{{ section.id }} .card__icon:hover { color: var(--accent-color); }

  #shop-market-{{ section.id }} .card__prices { display: flex; flex-direction: column; align-items: center; gap: .25rem; }
  #shop-market-{{ section.id }} .card__preci { display: block; text-align: center; }
  #shop-market-{{ section.id }} .card__preci--before { font-size: .8rem; color: var(--price-before-color); text-decoration: line-through; }
  #shop-market-{{ section.id }} .card__preci--now { font-size: 1rem; font-weight: 700; color: var(--price-now-color); }

  #shop-market-{{ section.id }} .card:hover .card__name { left: 0; }
  #shop-market-{{ section.id }} .card:hover .card__img { transform: rotate(30deg); margin-left: 3.5rem; }
  #shop-market-{{ section.id }} .card:hover .card__precis { margin-left: 3.5rem; padding: 0 1.5rem; }

  #shop-market-{{ section.id }} .card.placeholder { background: #f6f6f6; border: 1px dashed #ddd; }
  #shop-market-{{ section.id }} .card.placeholder .card__name { background: #222; color: #fff; }

  @media (max-width: 480px) {
    #shop-market-{{ section.id }} .card__icon { padding: .5rem; }
  }
</style>

{% schema %}
{
  "name": "Market cards grid",
  "settings": [
    { "type": "checkbox", "id": "show_heading", "label": "Afficher le titre", "default": true },
    { "type": "text", "id": "heading", "label": "Titre", "default": "MARKET" },
    { "type": "range", "id": "heading_size_desktop", "label": "Taille du titre (desktop, rem)", "min": 1.2, "max": 3.5, "step": 0.1, "default": 2.0 },
    { "type": "range", "id": "heading_size_mobile", "label": "Taille du titre (mobile, rem)", "min": 1.0, "max": 2.5, "step": 0.1, "default": 1.5 },
    { "type": "color", "id": "heading_color", "label": "Couleur du titre", "default": "#161616" },
    { "type": "checkbox", "id": "show_heading_line", "label": "Afficher la ligne après le titre", "default": true },
    { "type": "color", "id": "heading_line_color", "label": "Couleur de la ligne du titre", "default": "#161616" },

    { "type": "color", "id": "section_bg_color", "label": "Fond de la section", "default": "#ffffff" },
    { "type": "color", "id": "text_color", "label": "Couleur de texte", "default": "#161616" },
    { "type": "color", "id": "accent_color", "label": "Couleur d'accent (hover icônes)", "default": "#FF5151" },
    { "type": "color", "id": "icon_color", "label": "Couleur des icônes", "default": "#161616" },

    { "type": "color", "id": "price_now_color", "label": "Couleur prix actuel", "default": "#161616" },
    { "type": "color", "id": "price_before_color", "label": "Couleur prix barré (compare)", "default": "#FF5151" },

    { "type": "range", "id": "card_radius", "label": "Arrondi des cartes (px)", "min": 0, "max": 32, "step": 1, "default": 16 },
    { "type": "checkbox", "id": "hover_shadow", "label": "Ombre au survol", "default": true },

    { "type": "range", "id": "min_card_width", "label": "Largeur minimale d'une carte (px)", "min": 160, "max": 360, "step": 10, "default": 220 },
    { "type": "range", "id": "grid_gap", "label": "Espacement entre cartes (px)", "min": 8, "max": 48, "step": 2, "default": 32 },
    { "type": "text", "id": "max_width", "label": "Largeur max du conteneur (px ou %)", "default": "1200px" },
    { "type": "range", "id": "section_padding_y", "label": "Padding vertical (px)", "min": 0, "max": 120, "step": 4, "default": 32 },
    { "type": "range", "id": "section_padding_x", "label": "Padding horizontal (px)", "min": 0, "max": 80, "step": 4, "default": 20 },

    { "type": "color", "id": "card_default_bg", "label": "Fond par défaut des cartes", "default": "#E3F8FF" },
    { "type": "color", "id": "name_panel_bg", "label": "Fond par défaut de l'étiquette verticale", "default": "#161616" },
    { "type": "color", "id": "name_panel_text_color", "label": "Texte par défaut de l'étiquette verticale", "default": "#ffffff" }
  ],
  "blocks": [
    {
      "type": "product_card",
      "name": "Carte produit",
      "limit": 12,
      "settings": [
        { "type": "product", "id": "product", "label": "Produit" },
        { "type": "checkbox", "id": "use_product_title_as_label", "label": "Utiliser le titre du produit pour l'étiquette verticale", "default": true },
        { "type": "text", "id": "side_label", "label": "Texte personnalisé de l'étiquette (si décoche ci-dessus)", "default": "DETAYLI BAK" },
        { "type": "color", "id": "card_bg_color", "label": "Fond de la carte (optionnel)" },
        { "type": "color", "id": "side_bg_color", "label": "Fond de l'étiquette verticale (optionnel)" },
        { "type": "color", "id": "side_text_color", "label": "Texte de l'étiquette verticale (optionnel)" },
        { "type": "checkbox", "id": "show_compare_price", "label": "Afficher le prix barré si en promo", "default": true },
        { "type": "checkbox", "id": "show_heart", "label": "Afficher l'icône cœur", "default": true },
        { "type": "checkbox", "id": "show_cart", "label": "Afficher l'icône ajouter au panier", "default": true }
      ]
    }
  ],
  "presets": [
    { "name": "Market cards grid", "category": "Produits", "blocks": [
      { "type": "product_card" },
      { "type": "product_card" },
      { "type": "product_card" },
      { "type": "product_card" }
    ]}
  ]
}
{% endschema %}